<?xml version="1.0"?>
<root BTCPP_format="4" main_tree_to_execute="MissionExecution">

  <BehaviorTree ID="MissionExecution">

    <ReactiveSequence>

      <MissionExecutionGate
        mission_phase="{mission_phase}"
        mission_id="{mission_id}"
        mission_phase_request="{phase_request}"
        exec_state="{exec_state}" />


      <IfThenElse>

        <IsMissionPaused exec_state="{exec_state}" />


        <KeepRunningUntilFailure>
          <AlwaysSuccess/>
        </KeepRunningUntilFailure>

        <KeepRunningUntilFailure>

          <Switch4 variable="{mission_phase}"
                   case_1="SEARCH"
                   case_2="CONVERGE"
                   case_3="PIPELINE"
                   case_4="DONE">


            <Sequence>

              <StartWaypointAction action_name="/orca/waypoint_manager"/>

              <Parallel success_count="1" failure_count="1">

                <SearchPattern
                  duration="300.0"
                  square_size="10.0"/>

                <LandmarkEnumPolling
                  landmark_type="1"
                  duration="30.0"
                  landmark_id="{landmark_id}"
                  landmark_pose="{landmark_pose}"/>

              </Parallel>

              <StopWaypointAction action_name="/orca/waypoint_manager"/>

              <SetMissionPhase value="CONVERGE"
                               mission_phase_request="{phase_request}"/>

            </Sequence>


            <Sequence>

              <LandmarkConverge
                landmark_id="{landmark_id}"
                landmark_pose="{landmark_pose}"
                duration="5.0"/>

              <SetMissionPhase value="PIPELINE"
                               mission_phase_request="{phase_request}"/>

            </Sequence>

            <Sequence>

              <StartWaypointAction action_name="/orca/waypoint_manager"/>

              <PipelineFollowing duration="60.0"/>

              <StopWaypointAction action_name="/orca/waypoint_manager"/>

              <SetMissionPhase value="DONE"
                               mission_phase_request="{phase_request}"/>

            </Sequence>


            <AlwaysFailure/>

            <AlwaysSuccess/>

          </Switch4>

        </KeepRunningUntilFailure>

      </IfThenElse>

    </ReactiveSequence>

  </BehaviorTree>

</root>
